<!DOCTYPE html>
<head>

</head>

<body>

    <div id="paypal-error" style="display:none">
        <h2>Whoopsie Daisy</h2>
        <div>We seem to have a problem here</div>
        <pre id="error-message"></pre>
    </div>
    <div id="paypal-cancel" style="display:none">
        <h2>We are severly disappointed</h2>
        <div>You shuold definitely click the paypal button again</div>
    </div>
    <div id="paypal-button"></div>
    <pre id="paypal-details" style="display:none"></pre>
    <div id="paypal-confirmation" style="display:none">
        <button id="placeOrder" class="btn btn-default">Place Order</button>
    </div>
    <div id="paypal-end" style="display:none">
        <h2>Yay your payment is complete</h2>
        <pre id="paypal-execute-details"></pre>
    </div>
    </div>
    <a href="index.html">Go Back</a>

    <script src="../lib/helpers.js"></script>

    <!-- PayPal Script -->
    <script src="https://www.paypalobjects.com/api/checkout.js" data-version-4></script>
    <!-- Braintree Scripts -->
    <script src="https://js.braintreegateway.com/web/3.7.0/js/client.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.7.0/js/paypal-checkout.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.7.0/js/data-collector.min.js"></script>

    <script>
        // Exercise Setup
        
        function onCancel() {
            showDom('paypal-cancel');
        }
        function onError(err) {
            document.getElementById('error-message').textContent = err.message;
            showDom('paypal-error');
        }

        function handleResponse(result) {
            document.getElementById('paypal-execute-details').textContent = JSON.stringify(result, null, 2);
            showDom('paypal-end');
        }

        function formPopulate(data) {
            
            document.getElementById('paypal-details').textContent = JSON.stringify(data, null, 2);
            document.getElementById('firstName').value = data.FIRSTNAME;
            document.getElementById('lastName').value = data.LASTNAME;
            document.getElementById('street').value = data.SHIPTOSTREET;
            showDom('paypal-details');
            showDom('paypal-confirmation');
        
        }

        var auth = 'sandbox_mpkhypqr_wkqn2r5yxbvdgs4r';

        var braintreePaypalOptions = {
            flow: 'vault',
            intent: 'authorize',
            enableShippingAddress: true
        };
        var checkoutJs = {
            commit: false,
            locale: 'en_US',
            style: {
                size: 'medium',
                color: 'yellow',
                shape: 'pill'
            }
        };

        // END Setup

        
        braintree.client.create({
            authorization: auth
        }, function (clientErr, clientInstance) {
            
            // Create data collector
            braintree.dataCollector.create({ client: clientInstance, paypal: true }, function (err, data) {
                console.log('Risk Data:', data);
            });

            braintree.paypalCheckout.create({
                client: clientInstance
            }, function (paypalCheckoutErr, paypalCheckoutInstance) {
                
                var braintreeEnvironment = clientInstance.getConfiguration().gatewayConfiguration.environment;
        
                // Start Paypal Checkout.js Javascript
                paypal.Button.render({
                    env: braintreeEnvironment === 'production' ? 'production' : 'sandbox',
                    payment: function (resolve, reject) {
                        paypalCheckoutInstance.createPayment(braintreePaypalOptions, function (err, res) {
                            // Search chrome dev tools console tab for "BT createPayment:" to see what I am
                            console.log('BT createPayment:', res, err);
                            
                            if (err) {
                                reject(err);
                            } else {
                                resolve(res);
                            }
                        });
                    },   
                    onAuthorize: function (data, actions) {
                        return paypalCheckoutInstance.tokenizePayment(data, function (err, result) {
                            console.log('WHATAMI',result, err);
                            formPopulate(result);
                        });
                           
                    },
                    onCancel: onCancel,
                    onError: onError,
                    locale: checkoutJs.locale,
                    commit: checkoutJs.commit,
                    style: checkoutJs.style
                }, '#paypal-button').then(function () {
                    console.log('PayPal button ready!');
                });
        });
    });
    </script>
    
</body>
</html>